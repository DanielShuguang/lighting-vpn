# VPN 连接功能使用指南

## 功能概述

本应用现已支持真实的 VPN 连接功能，可以通过 V2Ray/Xray 核心连接到各种代理服务器。

## 前提条件

### 1. 安装 V2Ray 或 Xray

在使用连接功能之前，您需要安装 V2Ray 或 Xray 核心程序。

#### Windows 安装

**方式 1：下载并放置在程序目录**

1. 下载 V2Ray 或 Xray：
   - V2Ray: https://github.com/v2fly/v2ray-core/releases
   - Xray: https://github.com/XTLS/Xray-core/releases
2. 解压下载的文件
3. 将 `v2ray.exe` 或 `xray.exe` 复制到本程序的目录下

**方式 2：安装到系统路径**

1. 下载并安装到 `C:\Program Files\v2ray\` 或 `C:\Program Files\xray\`
2. 或将可执行文件路径添加到系统 PATH 环境变量

#### Linux/macOS 安装

```bash
# 安装 V2Ray
sudo bash -c "$(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)"

# 或安装 Xray
sudo bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)"
```

### 2. 支持的协议

当前版本支持以下协议：

- ✅ VMess
- ✅ Shadowsocks
- ✅ Trojan
- ✅ VLESS (V2Ray 协议)
- ❌ ShadowsocksR (暂不支持，需要专门的客户端)

## 使用步骤

### 1. 准备节点配置

通过以下任一方式添加节点配置：

#### 方式 A：手动导入配置链接

1. 点击主界面的「导入配置」按钮
2. 粘贴节点的分享链接（如 `vmess://...`、`ss://...` 等）
3. 点击导入

#### 方式 B：通过订阅获取

1. 点击「订阅管理」按钮
2. 添加订阅源（输入订阅名称和 URL）
3. 点击「更新」按钮获取节点列表

### 2. 测试节点延迟（可选但推荐）

连接前建议先测试节点的可用性：

**单节点测试**

- 找到要测试的节点
- 点击「测试」按钮
- 查看延迟结果

**批量测试**

- 点击主界面顶部的「批量测试」按钮
- 等待所有节点测试完成
- 选择延迟较低（绿色或黄色）的节点

### 3. 连接到节点

1. 在配置列表中找到要连接的节点
2. 点击该节点的「连接」按钮
3. 等待连接建立（约 2-3 秒）
4. 连接成功后：
   - 状态栏显示「已连接」
   - 系统代理自动设置
   - 可以开始使用代理上网

### 4. 断开连接

1. 找到当前已连接的节点（状态显示为「已连接」）
2. 点击「断开」按钮
3. 系统代理自动恢复为原始设置

## 连接原理

### 本地代理端口

连接成功后，应用会在本地启动以下端口：

- **HTTP 代理**: `127.0.0.1:10809`
- **SOCKS5 代理**: `127.0.0.1:10808`

### 系统代理设置

- **Windows**: 自动修改注册表中的 Internet 设置
- **macOS**: 使用 `networksetup` 命令设置系统代理
- **Linux**: 设置 GNOME 代理配置（如果可用）

### 配置文件

V2Ray 配置文件自动生成并保存在 `configs/` 目录下，断开连接后自动清理。

## 故障排除

### 1. 提示"未找到 V2Ray/Xray 可执行文件"

**原因**: 系统中没有安装 V2Ray 或 Xray

**解决方案**:

1. 按照上面的"前提条件"安装 V2Ray 或 Xray
2. 确保可执行文件在以下位置之一：
   - 程序当前目录
   - 系统 PATH 路径
   - Windows: `C:\Program Files\v2ray\` 或 `C:\Program Files\xray\`
   - Linux/Mac: `/usr/local/bin/` 或 `/usr/bin/`

### 2. 连接失败或无法访问网络

**可能原因**:

- 节点服务器不可用
- 节点配置信息错误
- 防火墙阻止连接
- 网络环境限制

**解决方案**:

1. 先进行延迟测试，确认节点可用
2. 尝试连接其他节点
3. 检查防火墙设置，允许 V2Ray/Xray 进程访问网络
4. 查看错误提示信息，根据提示排查

### 3. 连接后浏览器仍无法使用代理

**原因**: 部分浏览器可能不使用系统代理设置

**解决方案**:

- **Chrome/Edge**: 默认使用系统代理，应该可以正常工作
- **Firefox**: 需要在设置中配置为使用系统代理
  1. 打开设置 → 网络设置
  2. 选择"使用系统代理设置"
- **其他应用**: 手动配置代理为 `127.0.0.1:10809` (HTTP) 或 `127.0.0.1:10808` (SOCKS5)

### 4. 断开后系统代理未恢复

**解决方案**:

1. 重新连接然后正常断开
2. Windows: 手动在"Internet 选项"中关闭代理
3. macOS: 在"系统偏好设置 → 网络 → 高级 → 代理"中关闭代理
4. Linux: 使用 `gsettings set org.gnome.system.proxy mode 'none'` 命令

### 5. 程序崩溃后进程残留

**现象**: V2Ray/Xray 进程未正常退出，占用端口

**解决方案**:

**Windows**:

```powershell
# 查找进程
tasklist | findstr "v2ray\|xray"
# 结束进程（替换 PID 为实际进程号）
taskkill /F /PID <PID>
```

**Linux/macOS**:

```bash
# 查找进程
ps aux | grep -E "v2ray|xray"
# 结束进程
kill -9 <PID>
```

## 高级配置

### 手动配置应用代理

如果某些应用不使用系统代理，可以手动配置：

**HTTP 代理**:

- 服务器: `127.0.0.1`
- 端口: `10809`

**SOCKS5 代理**:

- 服务器: `127.0.0.1`
- 端口: `10808`

### 配置文件位置

- 应用配置: `vpn_configs.json`
- 订阅配置: `subscriptions.json`
- V2Ray 临时配置: `configs/config_<id>.json`

## 安全建议

1. **不要分享你的配置信息**: 节点链接包含敏感信息
2. **定期更新订阅**: 保持节点列表最新
3. **使用可信的订阅源**: 避免使用来源不明的订阅
4. **断开连接后检查**: 确保系统代理已恢复
5. **关闭应用前断开**: 避免进程残留

## 性能优化建议

1. **选择低延迟节点**: 优先使用延迟 < 100ms 的节点
2. **避免频繁切换**: 每次切换需要重启进程
3. **批量测试时机**: 建议在网络空闲时进行批量测试
4. **定期清理配置**: 删除不再使用的节点配置

## 支持的操作系统

- ✅ Windows 10/11
- ✅ macOS 10.15+
- ✅ Linux (需要 GNOME 桌面环境以获得最佳支持)

## 已知限制

1. **ShadowsocksR 不支持**: V2Ray 核心不支持 SSR 协议，需要专门的 SSR 客户端
2. **系统代理自动恢复**: 某些情况下可能需要手动恢复
3. **多用户环境**: 系统代理设置影响当前用户，不影响其他用户
4. **部分应用绕过系统代理**: 某些应用可能需要单独配置

## 反馈和支持

如果遇到问题或有改进建议，请：

1. 查看错误提示信息
2. 检查 V2Ray/Xray 是否正确安装
3. 确认节点配置信息正确
4. 尝试使用其他节点

## 更新日志

### v0.2.0

- ✅ 实现真实的 VPN 连接功能
- ✅ 支持 VMess、Shadowsocks、Trojan、VLESS 协议
- ✅ 自动系统代理设置
- ✅ 进程管理和清理
- ✅ 跨平台支持（Windows、macOS、Linux）

### v0.1.0

- ✅ 订阅管理功能
- ✅ 连接测试功能
- ✅ 批量延迟测试
